-- 코드를 입력하세요
SELECT C.CAR_ID, C.CAR_TYPE, ROUND(DAILY_FEE*30*(100-DISCOUNT_RATE)/100,0) AS FEE
FROM CAR_RENTAL_COMPANY_CAR AS C
JOIN (SELECT CAR_TYPE, MAX(DISCOUNT_RATE) AS DISCOUNT_RATE
     FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN
      WHERE NOT SUBSTRING(DURATION_TYPE,1,2) = '90' AND(CAR_TYPE = 'SUV' OR CAR_TYPE = '세단')
      GROUP BY CAR_TYPE
     ) AS D
ON C.CAR_TYPE = D.CAR_TYPE
WHERE (DAILY_FEE*30*(100-DISCOUNT_RATE)/100 >=500000 AND DAILY_FEE*30*(100-DISCOUNT_RATE)/100 <2000000) AND (C.CAR_TYPE = 'SUV'OR C.CAR_TYPE = '세단') AND C.CAR_ID NOT IN(
    SELECT CAR_ID
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
    WHERE (START_DATE BETWEEN '2022-11-01' AND '2022-11-30') OR (END_DATE BETWEEN '2022-11-01' AND '2022-11-30') OR (START_DATE <'2022-11-01' AND END_DATE>'2022-11-30')
    GROUP BY CAR_ID
)
ORDER BY FEE DESC, CAR_TYPE, CAR_ID DESC
    
